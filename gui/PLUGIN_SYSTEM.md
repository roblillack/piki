# Plugin System Documentation

## Overview

The Piki plugin system allows dynamic page content generation based on special page names that start with an exclamation mark (`!`). Plugins can inspect the current wiki state and generate markdown content on-the-fly.

## How It Works

### Triggering Plugins

1. **Link Syntax**: Create a wiki link with a `!` prefix: `[[!plugin-name]]`
2. **Navigation**: Click the link or use the Index menu (Ctrl+I)
3. **Result**: The plugin generates content dynamically instead of loading a file

### Plugin Architecture

The system consists of:

- **Plugin Trait**: Defines the interface plugins must implement
- **PluginRegistry**: Manages registered plugins
- **Integration**: AppState checks for `!` prefix and routes to plugins

## Built-in Plugins

### Index Plugin (`!index`)

Generates a sorted, hierarchical index of all pages in the wiki.

**Features:**

- Recursively scans all subdirectories
- Groups pages by top-level directory
- Shows "Root Pages" for top-level files
- Always up-to-date (regenerated on each visit)

**Usage:**

- Link: `[[!index]]`
- Menu: Ctrl+I
- Manual: Navigate to `!index`

**Example Output:**

```markdown
# Index

_Dynamically generated index of all 4 pages_

## Root Pages

- [[existing]]
- [[index]]

## project-a

- [[project-a/overview]]
- [[project-a/standup]]

---

_This page is generated by the `index` plugin_
```

## Implementation Details

### File Structure

```
src/
├── plugin.rs          # Plugin trait, registry, and IndexPlugin
├── document.rs        # Added list_all_documents() for recursive listing
└── main.rs            # AppState integration and plugin initialization
```

### Key Components

#### Plugin Trait (`src/plugin.rs`)

```rust
pub trait Plugin: Send + Sync {
    fn generate_content(&self, store: &DocumentStore) -> Result<String, String>;
}
```

#### Plugin Registry

```rust
pub struct PluginRegistry {
    plugins: HashMap<String, Box<dyn Plugin>>,
}
```

#### Page Loading Flow

1. User clicks `[[!index]]`
2. `AppState::load_page("!index")` is called
3. Detects `!` prefix and extracts "index"
4. Calls `plugin_registry.generate("index", &store)`
5. IndexPlugin generates content
6. Content is displayed in editor

### Status Bar

Plugin pages show special status:

```
Page: !index (plugin: index)
```

### Read-Only Mode

Plugin-generated pages are automatically set to read-only mode:

- **Text Selection**: You can still select and copy text
- **Navigation**: Arrow keys, Page Up/Down, Home/End work normally
- **No Editing**: Typing, backspace, delete, and paste are blocked
- **Visual Indicator**: Read-only pages have a slightly grayer background (RGB 245,245,245 vs 255,255,245)

This prevents accidental modifications to dynamically generated content.

## Creating New Plugins

To add a new plugin:

1. **Implement the Plugin trait:**

```rust
pub struct MyPlugin;

impl Plugin for MyPlugin {
    fn generate_content(&self, store: &DocumentStore) -> Result<String, String> {
        // Access store to read pages, list files, etc.
        let all_pages = store.list_all_documents()?;

        // Generate markdown content
        let mut content = String::from("# My Plugin\n\n");
        // ... your logic here

        Ok(content)
    }
}
```

2. **Register in main.rs:**

```rust
plugin_registry.register("myplugin", Box::new(MyPlugin));
```

3. **Use it:**

```markdown
[[!myplugin]]
```

## Testing

### Unit Tests

```bash
cargo test
```

Tests include:

- Plugin registration and retrieval
- IndexPlugin with empty/populated wikis
- Recursive document listing
- Integration tests

### Manual Testing

```bash
# Run with test-wiki
cargo run test-wiki

# Navigate to !index:
# - Click [[!index]] link on the index page
# - Or press Ctrl+I
```

## Example: test-wiki

The `test-wiki` directory demonstrates the plugin system:

```
test-wiki/
├── index.md              # Contains [[!index]] link and explanation
├── existing.md           # Regular page
└── project-a/
    ├── overview.md       # Nested page
    └── standup.md        # Nested page
```

When you navigate to `!index`, you'll see all 4 pages listed and organized.

## Future Enhancements

Potential plugin ideas:

- **!search**: Full-text search across all pages
- **!recent**: Recently modified pages
- **!orphans**: Pages with no incoming links
- **!backlinks**: Show pages linking to current page
- **!stats**: Wiki statistics (page count, word count, etc.)
- **!tags**: Tag-based navigation
- **!calendar**: Date-based page organization

## Architecture Benefits

1. **Extensible**: Easy to add new plugins without modifying core code
2. **Dynamic**: Content always reflects current wiki state
3. **Performant**: Generated on-demand, not stored
4. **Type-safe**: Rust's trait system ensures plugin safety
5. **Testable**: Plugins can be unit tested independently
